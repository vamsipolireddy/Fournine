---
- name: Install MySQL for production ready server
  user: vamsip
  hosts: all
  become: True
  become_user: root
  vars:
     wp_mysql_db: wordpress
     wp_mysql_user: wordpress
     wp_mysql_password: wp_123@
  tasks:
     - name: Install MySQL Packages
       yum: name={{ item }} update_cache=yes state=latest
       loop: [ 'mysql-server', 'php-mysqlnd', 'python3-pymysql' ]
 
     - name: Start mysqld servic
       systemd: name=mysql state=started enabled=yes
  
     - name: Change the authentication plugin of MySQL root user to mysql_native_password
       shell: mysql -u root -e 'UPDATE mysql.user SET plugin="mysql_native_password"
              WHERE user="root" AND host="localhost"'
     - name: Flush Privileges
       shell: mysql -u root -e 'FLUSH PRIVILEGES'
     - name: Set MySQL root password
       mysql_user:
        login_host: 'localhost'
        login_user: 'root'
        login_password: ''
        name: 'root'
        password: '{{ wp_mysql_password }}'
        state: present

        #     - name: Ensure root user can only login from localhost
        #mysql_user:
        # login_password: "{{ wp_mysql_password }}"
        #check_implicit_admin: yes
        #name: root
        #host: 'localhost'
        #password: "{{ wp_mysql_password }}"
        #state: present
    
     - name: Add .my.cnf to user home
       template:
          src: my.cnf.j2
          dest: /root/.my.cnf
        # with_items:
                #- localhost
           #- 127.0.0.1
           # - ::1

          #     - name: Set MySQL root Password
          # mysql_user:
          # login_host: 'localhost'
          #login_user: 'root'
          #login_password: vamsi123@
          #name: 'root'
         #password: '{{ wp_mysql_password }}'
         # state: present
 
     - name: Creates database for WordPress
       mysql_db:
        name: "{{ wp_mysql_db }}"
        state: present
        login_user: root
        login_password: "{{ wp_mysql_password }}"
 
     - name: Create MySQL user for WordPress
       mysql_user:
        name: "{{ wp_mysql_user }}"
        password: "{{ wp_mysql_password }}"
        priv: "{{ wp_mysql_db }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ wp_mysql_password }}"

